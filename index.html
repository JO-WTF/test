<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <!-- ç¦ç”¨ç¼©æ”¾ + å…¨é¢å±é€‚é… -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Perbarui Status DU</title>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- ä»…ä½¿ç”¨ @zxing/browserï¼ˆUMD å…¨å±€ä¸º ZXingBrowserï¼‰ -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <!-- å…œåº•ï¼šç¦æ­¢æåˆ/åŒå‡»ç¼©æ”¾ï¼ˆæ”¾åœ¨æœ€å‰é¢å°½æ—©ç”Ÿæ•ˆï¼‰ -->
  <script>
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    let __lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - __lastTouchEnd <= 300) {
        const t = e.target;
        if (!t.closest('input, textarea, select, a, button, label, [role="button"]')) {
          e.preventDefault();
        }
      }
      __lastTouchEnd = now;
    }, { passive: false });
    window.addEventListener('wheel', function(e){
      if (e.ctrlKey || e.metaKey) e.preventDefault();
    }, { passive: false });
  </script>

  <style>
    :root { --fg:#eaf2ff; --bg:#0b1020; --accent:#69a8ff; --muted:#8aa2c8; --ok:#66e6a4; --err:#ff9aa6; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    html,body{ -webkit-text-size-adjust:100%; touch-action:manipulation; }

    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px 40px;gap:16px}
    h1{font-size:18px;margin:0 0 4px;text-align:center;font-weight:600}

    /* è¯­è¨€åˆ‡æ¢ */
    .lang-switch{position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:1000}
    .lang-switch button{appearance:none;border:1px solid #2a3a66;background:#101831;color:var(--fg);padding:6px 10px;border-radius:999px;font-size:14px;display:flex;align-items:center;gap:6px;cursor:pointer}
    .lang-switch img{width:20px;height:14px;object-fit:cover;border-radius:2px}
    .lang-switch .active{outline:2px solid var(--accent);}

    /* æ‰«ææ¡†åŒºåŸŸï¼š16:9 */
    .scan-area{position:relative;width:min(84vw,520px);aspect-ratio:16/9;border-radius:16px;overflow:hidden;background:#000}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .corners{position:absolute;inset:0;pointer-events:none}
    .c{position:absolute;width:18%;height:40%;border:3px solid var(--accent)}
    .tl{left:10px;top:10px;border-right:0;border-bottom:0;border-radius:12px 0 0 0}
    .tr{right:10px;top:10px;border-left:0;border-bottom:0;border-radius:0 12px 0 0}
    .bl{left:10px;bottom:10px;border-right:0;border-top:0;border-radius:0 0 0 12px}
    .br{right:10px;bottom:10px;border-left:0;border-top:0;border-radius:0 0 12px 0}

    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:999px;padding:12px 16px;font-weight:600;background:#12182b;color:var(--fg);font-size:16px;cursor:pointer}
    .primary{background:var(--accent);color:#07122b}
    .ghost{background:#12182b;color:var(--fg)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .tag{font-size:12px;padding:8px 10px;border-radius:999px;background:#0f1730;border:1px solid #1f2a4d}

    .card{width:min(92vw,720px);background:#101831;border:1px solid #1f2a4d;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px}
    .card h2{font-size:16px;margin:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* çŠ¶æ€æ›´æ–°åŒºå— */
    .status-box{padding:14px;border:2px solid var(--accent);border-radius:12px;background:#0b1327;display:flex;flex-direction:column;gap:12px}
    .status-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .status-row label{font-weight:700}
    select.status{min-width:180px;font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #2a3a66;background:#0e1631;color:var(--fg)}

    .flex-2{display:flex;gap:12px;flex-wrap:wrap}
    .flex-2 > .col{flex:1 1 300px}
    textarea{width:100%;min-height:96px;resize:vertical;border-radius:12px;border:1px solid #2a3a66;background:#0e1631;color:var(--fg);padding:10px 12px;font-size:16px}

    .uploader{border:1px dashed #2a3a66;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start}
    .uploader input[type=file]{display:block;font-size:16px}
    .thumb{width:96px;height:96px;border-radius:10px;background:#081028;border:1px solid #20305a;object-fit:cover}

    /* å…³é”®ï¼šè¾“å…¥æ§ä»¶å­—å· >=16pxï¼Œé¿å…èšç„¦è‡ªåŠ¨ç¼©æ”¾ */
    input, select, textarea { font-size:16px; }

    .ok{color:var(--ok)}
    .err{color:var(--err)}

    /* â€”â€” è¿›åº¦æ¡ â€”â€” */
    .progress{position:relative;height:10px;background:#0f1730;border:1px solid #1f2a4d;border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--accent);transition:width .2s ease}
    .progress.indeterminate .progress-bar{width:30%;animation:indet 1.2s infinite}
    @keyframes indet{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
    .progress-text{margin-top:6px;font-size:12px;color:var(--muted)}

    /* æœªé€‰æ‹©çŠ¶æ€çš„æ˜¾è‘—æç¤º */
    .invalid{border-color:var(--err)!important; box-shadow:0 0 0 3px rgba(255,154,166,.15)}
    .hint{font-size:12px;color:var(--err)}
    .shake{animation:shake .25s linear 2}
    @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
  </style>
</head>
<body>
<div id="app" class="wrap">
  <!-- è¯­è¨€åˆ‡æ¢ -->
  <div class="lang-switch">
    <button :class="{active: state.lang==='zh'}" @click="setLang('zh')" aria-label="Switch to Chinese">
      <img src="https://flagcdn.com/w20/cn.png" alt="CN" />ä¸­æ–‡
    </button>
    <button :class="{active: state.lang==='en'}" @click="setLang('en')" aria-label="Switch to English">
      <img src="https://flagcdn.com/w20/gb.png" alt="GB" />English
    </button>
    <button :class="{active: state.lang==='id'}" @click="setLang('id')" aria-label="Beralih ke Bahasa Indonesia">
      <img src="https://flagcdn.com/w20/id.png" alt="ID" />Indonesia
    </button>
  </div>

  <div>
    <h1>{{ t('scanTitle') }}</h1>
  </div>

  <section class="scan-area">
    <video ref="video" playsinline muted autoplay></video>
    <div class="corners">
      <div class="c tl"></div>
      <div class="c tr"></div>
      <div class="c bl"></div>
      <div class="c br"></div>
    </div>
  </section>

  <div class="tag" v-if="state.torchSupported">{{ t('torch') }}ï¼š<b>{{ state.torchOn ? t('on') : t('off') }}</b></div>

  <div class="row" v-if="!state.last">
    <button class="primary" @click="start" :disabled="state.running">{{ t('startScan') }}</button>
    <button class="ghost" @click="stop" :disabled="!state.running">{{ t('stop') }}</button>
    <button class="ghost" @click="toggleTorch" :disabled="!state.running || !state.torchSupported">{{ t('torchToggle') }}</button>
  </div>

  <div class="card" v-if="state.last">
    <div class="row">
      <button class="primary" @click="resume">{{ t('rescan') }}</button>
    </div>
    <h2>{{ t('result') }}</h2>
    <div class="mono">{{ state.last.text }}</div>

    <template v-if="state.isValid">
      <div class="status-box">
        <div class="status-row" :class="{'shake': state.needsStatusShake}">
          <label for="duStatus">{{ t('updateStatus') }}ï¼š</label>
          <select
            id="duStatus"
            class="status"
            :class="{'invalid': state.needsStatusHint}"
            v-model="state.duStatus"
            aria-invalid="true"
            @change="state.needsStatusHint=false; state.needsStatusShake=false"
          >
            <option value="" disabled>{{ t('choose') }}</option>
            <!-- æ³¨æ„ï¼šæäº¤ç»™åç«¯çš„å€¼ä»ä¿ç•™ä¸­æ–‡ï¼ˆä¸åŸåç«¯å…¼å®¹ï¼‰ï¼ŒUI æ–‡æ¡ˆæœ¬åœ°åŒ– -->
            <option value="è¿è¾“ä¸­">{{ t('inTransit') }}</option>
            <option value="å·²åˆ°è¾¾">{{ t('arrived') }}</option>
          </select>
        </div>
        <div class="hint" v-if="state.needsStatusHint">{{ t('needSelectStatus') }}</div>

        <div class="flex-2">
          <div class="col">
            <label style="display:block;margin-bottom:6px">{{ t('remark') }}</label>
            <textarea v-model="state.remark" :placeholder="t('remarkPlaceholder')"></textarea>
          </div>
          <div class="col">
            <label style="display:block;margin-bottom:6px">{{ t('uploadPhoto') }}</label>
            <div class="uploader">
              <img v-if="state.photoPreview" :src="state.photoPreview" alt="preview" class="thumb" />
              <div style="display:flex;flex-direction:column;gap:8px">
                <input type="file" accept="image/*" capture="environment" @change="onPickPhoto" />
                <small class="muted">{{ t('photoTip') }}</small>
                <button v-if="state.photoFile" class="ghost" @click="clearPhoto">{{ t('removePhoto') }}</button>
              </div>
            </div>
          </div>
        </div>

        <button class="primary" style="align-self:flex-start" @click="submitUpdate" :disabled="!state.isValid || state.submitting">
          {{ state.submitting ? t('submitting') : t('submit') }}
        </button>

        <!-- æäº¤è¿›åº¦æ¡ï¼šæœ‰ç…§ç‰‡ => ç™¾åˆ†æ¯”ï¼›æ— ç…§ç‰‡ => ä¸ç¡®å®šåŠ¨ç”» -->
        <div v-if="state.submitting">
          <div class="progress" :class="{'indeterminate': !state.photoFile}">
            <div class="progress-bar" :style="{ width: (state.photoFile ? state.uploadPct : 100) + '%' }"></div>
          </div>
          <div class="progress-text">
            {{ state.photoFile ? (t('uploadingPct') + ' ' + state.uploadPct + '%') : t('submittingDots') }}
          </div>
        </div>

        <div v-if="state.submitMsg" :class="[state.submitOk ? 'ok' : 'err']">{{ state.submitMsg }}</div>
      </div>
    </template>

    <template v-else>
      <div class="err">{{ t('invalidId') }}</div>
    </template>
  </div>
</div>

<script>
const { createApp, ref, reactive, onMounted, onBeforeUnmount } = Vue;

/** ä¸‰è¯­è¨€æ–‡æ¡ˆ */
const translations = {
  zh: {
    // æ ‡é¢˜/æŒ‰é’®
    scanTitle:"ğŸ“· æ‰«ç ",
    torch:"é—ªå…‰ç¯", on:"å¼€", off:"å…³",
    startScan:"å¼€å§‹æ‰«æ", stop:"åœæ­¢", torchToggle:"åˆ‡æ¢é—ªå…‰ç¯",
    rescan:"é‡æ–°æ‰«æ", result:"è¯†åˆ«ç»“æœ",
    // è¡¨å•
    updateStatus:"æ›´æ–° DU çŠ¶æ€", choose:"è¯·é€‰æ‹©",
    inTransit:"è¿è¾“ä¸­", arrived:"å·²åˆ°è¾¾",
    remark:"å¤‡æ³¨ä¿¡æ¯", remarkPlaceholder:"å¯å¡«å†™é¢å¤–è¯´æ˜â€¦",
    uploadPhoto:"ä¸Šä¼ ç…§ç‰‡", photoTip:"æ”¯æŒæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©",
    removePhoto:"ç§»é™¤ç…§ç‰‡",
    // æ ¡éªŒ/æç¤º
    needSelectStatus:"è¯·å…ˆé€‰æ‹©è¿è¾“çŠ¶æ€",
    invalidId:"æ— æ•ˆçš„DU ID",
    // æäº¤
    submit:"æäº¤", submitting:"æäº¤ä¸­â€¦", submittingDots:"æäº¤ä¸­â€¦",
    uploadIng:"ä¸Šä¼ ä¸­â€¦", uploadingPct:"ä¸Šä¼ ä¸­ï¼š",
    submitSuccess:"æäº¤æˆåŠŸ",
    submitCanceled:"æäº¤å·²å–æ¶ˆ",
    submitNetworkErr:"æäº¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯",
    submitHttpErrPrefix:"æäº¤å¤±è´¥ï¼š",
    apiUrlMissing:"æœªé…ç½®åç«¯ API_URLï¼Œè¯·åœ¨é¡µé¢é¡¶éƒ¨é€šè¿‡ window.API_URL æˆ–ç›´æ¥æ”¹ä»£ç è®¾ç½®çœŸå®åœ°å€"
  },
  en: {
    scanTitle:"ğŸ“· Scan",
    torch:"Torch", on:"On", off:"Off",
    startScan:"Start Scan", stop:"Stop", torchToggle:"Toggle Torch",
    rescan:"Rescan", result:"Result",
    updateStatus:"Update DU Status", choose:"Please select",
    inTransit:"In Transit", arrived:"Arrived",
    remark:"Remark", remarkPlaceholder:"Optional notesâ€¦",
    uploadPhoto:"Upload Photo", photoTip:"Take or choose from gallery",
    removePhoto:"Remove Photo",
    needSelectStatus:"Please select a shipping status",
    invalidId:"Invalid DU ID",
    submit:"Submit", submitting:"Submittingâ€¦", submittingDots:"Submittingâ€¦",
    uploadIng:"Uploadingâ€¦", uploadingPct:"Uploading:",
    submitSuccess:"Submitted successfully",
    submitCanceled:"Submission canceled",
    submitNetworkErr:"Submission failed: Network error",
    submitHttpErrPrefix:"Submission failed: ",
    apiUrlMissing:"API_URL not configured. Set it via window.API_URL or in code."
  },
  id: {
    scanTitle:"ğŸ“· Pindai",
    torch:"Lampu", on:"Nyala", off:"Mati",
    startScan:"Mulai Pindai", stop:"Berhenti", torchToggle:"Ubah Lampu",
    rescan:"Pindai Ulang", result:"Hasil",
    updateStatus:"Perbarui Status DU", choose:"Silakan pilih",
    inTransit:"Dalam Perjalanan", arrived:"Tiba",
    remark:"Catatan", remarkPlaceholder:"Tambahkan keteranganâ€¦",
    uploadPhoto:"Unggah Foto", photoTip:"Dukung kamera atau galeri",
    removePhoto:"Hapus Foto",
    needSelectStatus:"Silakan pilih status pengiriman",
    invalidId:"ID DU tidak valid",
    submit:"Kirim", submitting:"Mengirimâ€¦", submittingDots:"Mengirimâ€¦",
    uploadIng:"Mengunggahâ€¦", uploadingPct:"Mengunggah:",
    submitSuccess:"Berhasil dikirim",
    submitCanceled:"Pengiriman dibatalkan",
    submitNetworkErr:"Gagal kirim: Kesalahan jaringan",
    submitHttpErrPrefix:"Gagal kirim: ",
    apiUrlMissing:"API_URL belum dikonfigurasi. Atur via window.API_URL atau di kode."
  }
};

createApp({
  setup(){
    const video = ref(null);
    const API_URL = (window.API_URL || 'https://jakartabackend.onrender.com/api/du/update');

    function createReader(){
      try{
        const hints = new Map();
        const F = ZXingBrowser.BarcodeFormat;
        const H = ZXingBrowser.DecodeHintType;
        hints.set(H.POSSIBLE_FORMATS, [F.QR_CODE, F.CODE_128, F.CODE_39, F.EAN_13, F.EAN_8]);
        return new ZXingBrowser.BrowserMultiFormatReader(hints, 250);
      }catch{ return new ZXingBrowser.BrowserMultiFormatReader(); }
    }
    const reader = createReader();

    const state = reactive({
      lang:'id',              // é»˜è®¤å°å°¼è¯­
      running:false,
      last:null,
      locked:false,
      torchSupported:false,
      torchOn:false,
      isValid:false,
      duStatus:"",
      remark:"",
      photoFile:null,
      photoPreview:"",
      submitting:false,
      submitOk:false,
      submitMsg:"",
      uploadPct:0,
      needsStatusHint:false,   // æœªé€‰çŠ¶æ€æ—¶çš„æç¤º
      needsStatusShake:false,  // æŠ–åŠ¨ä¸€æ¬¡
    });

    const DIGIT_DU_RE = /^\d{10,20}$/;
    let controls = null;
    let inactivityTimer = null;

    const t = (k)=> (translations[state.lang] && translations[state.lang][k]) || k;

    const setLang = (l)=>{
      state.lang = l;
      document.documentElement.lang = l;
      // åŒæ­¥æ ‡é¢˜
      const titleMap = { zh:'æ‰‹æœºæ‰«ç  - çŠ¶æ€æ›´æ–°', en:'Scanner - Status Update', id:'Pemindaian - Pembaruan Status' };
      document.title = titleMap[l] || 'DU Status Update';
    };

    function clearInactivity(){ if(inactivityTimer){ clearTimeout(inactivityTimer); inactivityTimer=null; } }
    function startInactivityCountdown(){ clearInactivity(); inactivityTimer = setTimeout(()=>{ stop(); }, 2*60*1000); }

    async function detectTorchSupport(){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        const caps = track?.getCapabilities?.();
        state.torchSupported = !!(caps && 'torch' in caps);
      }catch{ state.torchSupported = false; }
    }

    async function applyTorch(on){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        if(!track) return;
        await track.applyConstraints({ advanced:[{ torch: !!on }] });
        state.torchOn = !!on;
      }catch{ state.torchOn = false; }
    }

    async function enhanceTrack(){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        if(!track) return;
        try{ const ic = new ImageCapture(track); await ic.setOptions?.({ focusMode: 'continuous' }); }catch{}
        try{
          const caps = track.getCapabilities?.();
          if(caps?.zoom){
            const z=caps.zoom;
            const target=Math.min(z.max, Math.max(z.min||1,(z.min||1)*1.3));
            await track.applyConstraints({ advanced: [{ zoom: target }] });
          }
        }catch{}
      }catch{}
    }

    async function buildBackCameraConstraints(){
      const tries = [
        { video: { facingMode: { exact: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
        { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
      ];
      for(const c of tries){
        try{ const s = await navigator.mediaDevices.getUserMedia(c); s.getTracks().forEach(t=>t.stop()); return c; }catch{}
      }
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        const back = cams.find(d=>!/front|user/i.test(d.label)) || cams[0];
        if(back){ return { video: { deviceId: { exact: back.deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false }; }
      }catch{}
      return { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };
    }

    const start = async ()=>{
      if (state.running) return;
      try{
        state.running = true;
        state.locked = false;
        clearInactivity();
        try{ controls?.stop(); }catch{}

        let constraints = await buildBackCameraConstraints();
        try{
          controls = await reader.decodeFromConstraints(
            constraints,
            video.value,
            async (result, err, _controls) => {
              if (result && !state.locked) {
                state.locked = true;
                const text = result.getText();
                const format = result.getBarcodeFormat();
                state.isValid = DIGIT_DU_RE.test(text);
                state.duStatus = "";
                state.remark = "";
                clearPhoto();
                state.submitMsg = "";
                state.submitOk = false;
                state.needsStatusHint = false;
                state.needsStatusShake = false;
                state.last = { text, format };
                try{ _controls.stop(); }catch{}
                try{ reader.reset(); }catch{}
                await applyTorch(false);
                await detectTorchSupport();
                state.running = false;
                clearInactivity();
                try{ navigator.vibrate?.(30); }catch{}
              }
            }
          );
        }catch(e){
          if(e && (e.name==='OverconstrainedError' || e.name==='NotFoundError')){
            constraints = { video: true, audio:false };
            controls = await reader.decodeFromConstraints(constraints, video.value, ()=>{});
          }else{ throw e; }
        }

        await enhanceTrack();
        await detectTorchSupport();
        startInactivityCountdown();
      }catch(e){
        console.error(e);
        alert('Camera error: ' + (e?.name || '') + (e?.message ? (' - ' + e.message) : ''));
        state.running = false;
      }
    };

    const hardStopStream = ()=>{
      const s = video.value?.srcObject;
      if (s && s.getTracks) s.getTracks().forEach(t=>{ try{ t.stop(); }catch{} });
      if (video.value) video.value.srcObject = null;
      state.torchOn = false;
      state.torchSupported = false;
    };

    const stop = async ()=>{
      try{ controls?.stop(); }catch{}
      try{ reader.reset(); }catch{}
      try{ await applyTorch(false); }catch{}
      hardStopStream();
      state.running=false; state.locked=false;
      clearInactivity();
    };

    const resume = async ()=>{
      state.last=null; state.locked=false; state.isValid=false;
      state.duStatus=""; state.remark="";
      clearPhoto();
      state.submitMsg=""; state.submitOk=false;
      state.needsStatusHint=false; state.needsStatusShake=false;
      await start();
    };

    const onPickPhoto = (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      state.photoFile = file;
      try{ state.photoPreview = URL.createObjectURL(file); }catch{ state.photoPreview = ''; }
    };

    const clearPhoto = ()=>{
      try{ state.photoPreview && URL.revokeObjectURL(state.photoPreview); }catch{}
      state.photoPreview = '';
      state.photoFile = null;
    };

    // â€”â€” ä½¿ç”¨ XHR è·å–ä¸Šä¼ è¿›åº¦ + æœ¬åœ°åŒ–æ¶ˆæ¯ â€”â€” //
    const submitUpdate = async ()=>{
      if(!state.isValid){
        state.submitOk=false; state.submitMsg=t('invalidId'); return;
      }
      if(!state.duStatus){
        state.submitOk=false;
        state.submitMsg = t('needSelectStatus');
        state.needsStatusHint = true;
        state.needsStatusShake = true;
        // èšç„¦ä¸‹æ‹‰
        requestAnimationFrame(()=>{
          const sel = document.getElementById('duStatus');
          if(sel){ sel.focus(); }
          setTimeout(()=>{ state.needsStatusShake=false; }, 400);
        });
        return;
      }

      state.submitting = true;
      state.submitMsg = '';
      state.submitOk = false;
      state.uploadPct = 0;

      try{
        const isPlaceholder = !API_URL || /<ä½ çš„-render-åŸŸå>/.test(API_URL);
        if(isPlaceholder){
          throw new Error(t('apiUrlMissing'));
        }

        const fd = new FormData();
        fd.append('duId', state.last.text);
        fd.append('status', state.duStatus);         // ä¾æ—§ä¼ ä¸­æ–‡å€¼ä»¥å…¼å®¹åç«¯
        fd.append('remark', state.remark || '');
        if(state.photoFile) fd.append('photo', state.photoFile);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', API_URL, true);

        // ä¸Šä¼ è¿›åº¦
        xhr.upload.onprogress = (e)=>{
          if(e && e.lengthComputable){
            state.uploadPct = Math.min(100, Math.round(e.loaded / e.total * 100));
          }
        };

        xhr.onerror = ()=>{ state.submitOk = false; state.submitMsg = t('submitNetworkErr'); state.submitting = false; };
        xhr.onabort = ()=>{ state.submitOk = false; state.submitMsg = t('submitCanceled'); state.submitting = false; };

        xhr.onreadystatechange = ()=>{
          if(xhr.readyState !== 4) return;
          const status = xhr.status;
          const text = xhr.responseText || '';
          let data = null; try{ data = text ? JSON.parse(text) : null }catch{}

          if(status >= 200 && status < 300){
            // è‹¥åç«¯æœªè¿”å› ok/successï¼Œåˆ™è§†ä¸ºæˆåŠŸï¼ˆä¸åŸé€»è¾‘ä¸€è‡´ï¼‰
            const ok = (data && (data.ok===true || data.success===true)) || true;
            state.submitOk = !!ok;
            state.submitMsg = ok ? (data?.message || t('submitSuccess')) : (data?.message || (t('submitHttpErrPrefix') + 'unknown'));
            state.uploadPct = 100;
            if(ok){ setTimeout(()=>{ resume(); }, 600); }
          }else{
            const msg = (data && (data.detail || data.message)) || ('HTTP ' + status);
            state.submitOk = false;
            state.submitMsg = t('submitHttpErrPrefix') + msg;
          }
          state.submitting = false;
        };

        xhr.send(fd);
      }catch(err){
        console.error(err);
        state.submitOk = false;
        state.submitMsg = t('submitHttpErrPrefix') + (err?.message || err);
        state.submitting = false;
      }
    };

    onMounted(async ()=>{
      // é»˜è®¤è¯­è¨€ï¼šå°å°¼è¯­
      setLang('id');

      video.value?.setAttribute('playsinline','true');
      video.value?.setAttribute('muted','muted');
      document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stop(); });
      window.addEventListener('pagehide', stop);
      await start(); // æ‰“å¼€é¡µé¢è‡ªåŠ¨å¼€å¯æ‘„åƒå¤´
    });

    onBeforeUnmount(()=>{ stop(); });

    return {
      state, video,
      t, setLang,
      start, stop, resume,
      toggleTorch: async ()=>{ if(state.torchSupported) await applyTorch(!state.torchOn); },
      submitUpdate, onPickPhoto, clearPhoto
    };
  }
}).mount('#app');
</script>
</body>
</html>
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <!-- ç¦ç”¨ç¼©æ”¾ + å…¨é¢å±é€‚é… -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Perbarui Status DU</title>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- ä»…ä½¿ç”¨ @zxing/browserï¼ˆUMD å…¨å±€ä¸º ZXingBrowserï¼‰ -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <!-- å…œåº•ï¼šç¦æ­¢æåˆ/åŒå‡»ç¼©æ”¾ï¼ˆæ”¾åœ¨æœ€å‰é¢å°½æ—©ç”Ÿæ•ˆï¼‰ -->
  <script>
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    let __lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - __lastTouchEnd <= 300) {
        const t = e.target;
        if (!t.closest('input, textarea, select, a, button, label, [role="button"]')) {
          e.preventDefault();
        }
      }
      __lastTouchEnd = now;
    }, { passive: false });
    window.addEventListener('wheel', function(e){
      if (e.ctrlKey || e.metaKey) e.preventDefault();
    }, { passive: false });
  </script>

  <style>
    :root { --fg:#eaf2ff; --bg:#0b1020; --accent:#69a8ff; --muted:#8aa2c8; --ok:#66e6a4; --err:#ff9aa6; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    html,body{ -webkit-text-size-adjust:100%; touch-action:manipulation; }

    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px 40px;gap:16px}
    h1{font-size:18px;margin:0 0 4px;text-align:center;font-weight:600}

    /* è¯­è¨€åˆ‡æ¢ */
    .lang-switch{position:fixed;top:10px;right:10px;display:flex;gap:8px;z-index:1000}
    .lang-switch button{appearance:none;border:1px solid #2a3a66;background:#101831;color:var(--fg);padding:6px 10px;border-radius:999px;font-size:14px;display:flex;align-items:center;gap:6px;cursor:pointer}
    .lang-switch img{width:20px;height:14px;object-fit:cover;border-radius:2px}
    .lang-switch .active{outline:2px solid var(--accent);}

    /* æ‰«ææ¡†åŒºåŸŸï¼š16:9 */
    .scan-area{position:relative;width:min(84vw,520px);aspect-ratio:16/9;border-radius:16px;overflow:hidden;background:#000}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .corners{position:absolute;inset:0;pointer-events:none}
    .c{position:absolute;width:18%;height:40%;border:3px solid var(--accent)}
    .tl{left:10px;top:10px;border-right:0;border-bottom:0;border-radius:12px 0 0 0}
    .tr{right:10px;top:10px;border-left:0;border-bottom:0;border-radius:0 12px 0 0}
    .bl{left:10px;bottom:10px;border-right:0;border-top:0;border-radius:0 0 0 12px}
    .br{right:10px;bottom:10px;border-left:0;border-top:0;border-radius:0 0 12px 0}

    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:999px;padding:12px 16px;font-weight:600;background:#12182b;color:var(--fg);font-size:16px;cursor:pointer}
    .primary{background:var(--accent);color:#07122b}
    .ghost{background:#12182b;color:var(--fg)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .tag{font-size:12px;padding:8px 10px;border-radius:999px;background:#0f1730;border:1px solid #1f2a4d}

    .card{width:min(92vw,720px);background:#101831;border:1px solid #1f2a4d;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px}
    .card h2{font-size:16px;margin:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* çŠ¶æ€æ›´æ–°åŒºå— */
    .status-box{padding:14px;border:2px solid var(--accent);border-radius:12px;background:#0b1327;display:flex;flex-direction:column;gap:12px}
    .status-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .status-row label{font-weight:700}
    select.status{min-width:180px;font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #2a3a66;background:#0e1631;color:var(--fg)}

    .flex-2{display:flex;gap:12px;flex-wrap:wrap}
    .flex-2 > .col{flex:1 1 300px}
    textarea{width:100%;min-height:96px;resize:vertical;border-radius:12px;border:1px solid #2a3a66;background:#0e1631;color:var(--fg);padding:10px 12px;font-size:16px}

    .uploader{border:1px dashed #2a3a66;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start}
    .uploader input[type=file]{display:block;font-size:16px}
    .thumb{width:96px;height:96px;border-radius:10px;background:#081028;border:1px solid #20305a;object-fit:cover}

    /* å…³é”®ï¼šè¾“å…¥æ§ä»¶å­—å· >=16pxï¼Œé¿å…èšç„¦è‡ªåŠ¨ç¼©æ”¾ */
    input, select, textarea { font-size:16px; }

    .ok{color:var(--ok)}
    .err{color:var(--err)}

    /* â€”â€” è¿›åº¦æ¡ â€”â€” */
    .progress{position:relative;height:10px;background:#0f1730;border:1px solid #1f2a4d;border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--accent);transition:width .2s ease}
    .progress.indeterminate .progress-bar{width:30%;animation:indet 1.2s infinite}
    @keyframes indet{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
    .progress-text{margin-top:6px;font-size:12px;color:var(--muted)}

    /* æœªé€‰æ‹©çŠ¶æ€çš„æ˜¾è‘—æç¤º */
    .invalid{border-color:var(--err)!important; box-shadow:0 0 0 3px rgba(255,154,166,.15)}
    .hint{font-size:12px;color:var(--err)}
    .shake{animation:shake .25s linear 2}
    @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
  </style>
</head>
<body>
<div id="app" class="wrap">
  <!-- è¯­è¨€åˆ‡æ¢ -->
  <div class="lang-switch">
    <button :class="{active: state.lang==='zh'}" @click="setLang('zh')" aria-label="Switch to Chinese">
      <img src="https://flagcdn.com/w20/cn.png" alt="CN" />ä¸­æ–‡
    </button>
    <button :class="{active: state.lang==='en'}" @click="setLang('en')" aria-label="Switch to English">
      <img src="https://flagcdn.com/w20/gb.png" alt="GB" />English
    </button>
    <button :class="{active: state.lang==='id'}" @click="setLang('id')" aria-label="Beralih ke Bahasa Indonesia">
      <img src="https://flagcdn.com/w20/id.png" alt="ID" />Indonesia
    </button>
  </div>

  <div>
    <h1>{{ t('scanTitle') }}</h1>
  </div>

  <section class="scan-area">
    <video ref="video" playsinline muted autoplay></video>
    <div class="corners">
      <div class="c tl"></div>
      <div class="c tr"></div>
      <div class="c bl"></div>
      <div class="c br"></div>
    </div>
  </section>

  <div class="tag" v-if="state.torchSupported">{{ t('torch') }}ï¼š<b>{{ state.torchOn ? t('on') : t('off') }}</b></div>

  <div class="row" v-if="!state.last">
    <button class="primary" @click="start" :disabled="state.running">{{ t('startScan') }}</button>
    <button class="ghost" @click="stop" :disabled="!state.running">{{ t('stop') }}</button>
    <button class="ghost" @click="toggleTorch" :disabled="!state.running || !state.torchSupported">{{ t('torchToggle') }}</button>
  </div>

  <div class="card" v-if="state.last">
    <div class="row">
      <button class="primary" @click="resume">{{ t('rescan') }}</button>
    </div>
    <h2>{{ t('result') }}</h2>
    <div class="mono">{{ state.last.text }}</div>

    <template v-if="state.isValid">
      <div class="status-box">
        <div class="status-row" :class="{'shake': state.needsStatusShake}">
          <label for="duStatus">{{ t('updateStatus') }}ï¼š</label>
          <select
            id="duStatus"
            class="status"
            :class="{'invalid': state.needsStatusHint}"
            v-model="state.duStatus"
            aria-invalid="true"
            @change="state.needsStatusHint=false; state.needsStatusShake=false"
          >
            <option value="" disabled>{{ t('choose') }}</option>
            <!-- æ³¨æ„ï¼šæäº¤ç»™åç«¯çš„å€¼ä»ä¿ç•™ä¸­æ–‡ï¼ˆä¸åŸåç«¯å…¼å®¹ï¼‰ï¼ŒUI æ–‡æ¡ˆæœ¬åœ°åŒ– -->
            <option value="è¿è¾“ä¸­">{{ t('inTransit') }}</option>
            <option value="å·²åˆ°è¾¾">{{ t('arrived') }}</option>
          </select>
        </div>
        <div class="hint" v-if="state.needsStatusHint">{{ t('needSelectStatus') }}</div>

        <div class="flex-2">
          <div class="col">
            <label style="display:block;margin-bottom:6px">{{ t('remark') }}</label>
            <textarea v-model="state.remark" :placeholder="t('remarkPlaceholder')"></textarea>
          </div>
          <div class="col">
            <label style="display:block;margin-bottom:6px">{{ t('uploadPhoto') }}</label>
            <div class="uploader">
              <img v-if="state.photoPreview" :src="state.photoPreview" alt="preview" class="thumb" />
              <div style="display:flex;flex-direction:column;gap:8px">
                <input type="file" accept="image/*" capture="environment" @change="onPickPhoto" />
                <small class="muted">{{ t('photoTip') }}</small>
                <button v-if="state.photoFile" class="ghost" @click="clearPhoto">{{ t('removePhoto') }}</button>
              </div>
            </div>
          </div>
        </div>

        <button class="primary" style="align-self:flex-start" @click="submitUpdate" :disabled="!state.isValid || state.submitting">
          {{ state.submitting ? t('submitting') : t('submit') }}
        </button>

        <!-- æäº¤è¿›åº¦æ¡ï¼šæœ‰ç…§ç‰‡ => ç™¾åˆ†æ¯”ï¼›æ— ç…§ç‰‡ => ä¸ç¡®å®šåŠ¨ç”» -->
        <div v-if="state.submitting">
          <div class="progress" :class="{'indeterminate': !state.photoFile}">
            <div class="progress-bar" :style="{ width: (state.photoFile ? state.uploadPct : 100) + '%' }"></div>
          </div>
          <div class="progress-text">
            {{ state.photoFile ? (t('uploadingPct') + ' ' + state.uploadPct + '%') : t('submittingDots') }}
          </div>
        </div>

        <div v-if="state.submitMsg" :class="[state.submitOk ? 'ok' : 'err']">{{ state.submitMsg }}</div>
      </div>
    </template>

    <template v-else>
      <div class="err">{{ t('invalidId') }}</div>
    </template>
  </div>
</div>

<script>
const { createApp, ref, reactive, onMounted, onBeforeUnmount } = Vue;

/** ä¸‰è¯­è¨€æ–‡æ¡ˆ */
const translations = {
  zh: {
    // æ ‡é¢˜/æŒ‰é’®
    scanTitle:"ğŸ“· æ‰«ç ",
    torch:"é—ªå…‰ç¯", on:"å¼€", off:"å…³",
    startScan:"å¼€å§‹æ‰«æ", stop:"åœæ­¢", torchToggle:"åˆ‡æ¢é—ªå…‰ç¯",
    rescan:"é‡æ–°æ‰«æ", result:"è¯†åˆ«ç»“æœ",
    // è¡¨å•
    updateStatus:"æ›´æ–° DU çŠ¶æ€", choose:"è¯·é€‰æ‹©",
    inTransit:"è¿è¾“ä¸­", arrived:"å·²åˆ°è¾¾",
    remark:"å¤‡æ³¨ä¿¡æ¯", remarkPlaceholder:"å¯å¡«å†™é¢å¤–è¯´æ˜â€¦",
    uploadPhoto:"ä¸Šä¼ ç…§ç‰‡", photoTip:"æ”¯æŒæ‹ç…§æˆ–ä»ç›¸å†Œé€‰æ‹©",
    removePhoto:"ç§»é™¤ç…§ç‰‡",
    // æ ¡éªŒ/æç¤º
    needSelectStatus:"è¯·å…ˆé€‰æ‹©è¿è¾“çŠ¶æ€",
    invalidId:"æ— æ•ˆçš„DU ID",
    // æäº¤
    submit:"æäº¤", submitting:"æäº¤ä¸­â€¦", submittingDots:"æäº¤ä¸­â€¦",
    uploadIng:"ä¸Šä¼ ä¸­â€¦", uploadingPct:"ä¸Šä¼ ä¸­ï¼š",
    submitSuccess:"æäº¤æˆåŠŸ",
    submitCanceled:"æäº¤å·²å–æ¶ˆ",
    submitNetworkErr:"æäº¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯",
    submitHttpErrPrefix:"æäº¤å¤±è´¥ï¼š",
    apiUrlMissing:"æœªé…ç½®åç«¯ API_URLï¼Œè¯·åœ¨é¡µé¢é¡¶éƒ¨é€šè¿‡ window.API_URL æˆ–ç›´æ¥æ”¹ä»£ç è®¾ç½®çœŸå®åœ°å€"
  },
  en: {
    scanTitle:"ğŸ“· Scan",
    torch:"Torch", on:"On", off:"Off",
    startScan:"Start Scan", stop:"Stop", torchToggle:"Toggle Torch",
    rescan:"Rescan", result:"Result",
    updateStatus:"Update DU Status", choose:"Please select",
    inTransit:"In Transit", arrived:"Arrived",
    remark:"Remark", remarkPlaceholder:"Optional notesâ€¦",
    uploadPhoto:"Upload Photo", photoTip:"Take or choose from gallery",
    removePhoto:"Remove Photo",
    needSelectStatus:"Please select a shipping status",
    invalidId:"Invalid DU ID",
    submit:"Submit", submitting:"Submittingâ€¦", submittingDots:"Submittingâ€¦",
    uploadIng:"Uploadingâ€¦", uploadingPct:"Uploading:",
    submitSuccess:"Submitted successfully",
    submitCanceled:"Submission canceled",
    submitNetworkErr:"Submission failed: Network error",
    submitHttpErrPrefix:"Submission failed: ",
    apiUrlMissing:"API_URL not configured. Set it via window.API_URL or in code."
  },
  id: {
    scanTitle:"ğŸ“· Pindai",
    torch:"Lampu", on:"Nyala", off:"Mati",
    startScan:"Mulai Pindai", stop:"Berhenti", torchToggle:"Ubah Lampu",
    rescan:"Pindai Ulang", result:"Hasil",
    updateStatus:"Perbarui Status DU", choose:"Silakan pilih",
    inTransit:"Dalam Perjalanan", arrived:"Tiba",
    remark:"Catatan", remarkPlaceholder:"Tambahkan keteranganâ€¦",
    uploadPhoto:"Unggah Foto", photoTip:"Dukung kamera atau galeri",
    removePhoto:"Hapus Foto",
    needSelectStatus:"Silakan pilih status pengiriman",
    invalidId:"ID DU tidak valid",
    submit:"Kirim", submitting:"Mengirimâ€¦", submittingDots:"Mengirimâ€¦",
    uploadIng:"Mengunggahâ€¦", uploadingPct:"Mengunggah:",
    submitSuccess:"Berhasil dikirim",
    submitCanceled:"Pengiriman dibatalkan",
    submitNetworkErr:"Gagal kirim: Kesalahan jaringan",
    submitHttpErrPrefix:"Gagal kirim: ",
    apiUrlMissing:"API_URL belum dikonfigurasi. Atur via window.API_URL atau di kode."
  }
};

createApp({
  setup(){
    const video = ref(null);
    const API_URL = (window.API_URL || 'https://jakartabackend.onrender.com/api/du/update');

    function createReader(){
      try{
        const hints = new Map();
        const F = ZXingBrowser.BarcodeFormat;
        const H = ZXingBrowser.DecodeHintType;
        hints.set(H.POSSIBLE_FORMATS, [F.QR_CODE, F.CODE_128, F.CODE_39, F.EAN_13, F.EAN_8]);
        return new ZXingBrowser.BrowserMultiFormatReader(hints, 250);
      }catch{ return new ZXingBrowser.BrowserMultiFormatReader(); }
    }
    const reader = createReader();

    const state = reactive({
      lang:'id',              // é»˜è®¤å°å°¼è¯­
      running:false,
      last:null,
      locked:false,
      torchSupported:false,
      torchOn:false,
      isValid:false,
      duStatus:"",
      remark:"",
      photoFile:null,
      photoPreview:"",
      submitting:false,
      submitOk:false,
      submitMsg:"",
      uploadPct:0,
      needsStatusHint:false,   // æœªé€‰çŠ¶æ€æ—¶çš„æç¤º
      needsStatusShake:false,  // æŠ–åŠ¨ä¸€æ¬¡
    });

    const DIGIT_DU_RE = /^\d{10,20}$/;
    let controls = null;
    let inactivityTimer = null;

    const t = (k)=> (translations[state.lang] && translations[state.lang][k]) || k;

    const setLang = (l)=>{
      state.lang = l;
      document.documentElement.lang = l;
      // åŒæ­¥æ ‡é¢˜
      const titleMap = { zh:'æ‰‹æœºæ‰«ç  - çŠ¶æ€æ›´æ–°', en:'Scanner - Status Update', id:'Pemindaian - Pembaruan Status' };
      document.title = titleMap[l] || 'DU Status Update';
    };

    function clearInactivity(){ if(inactivityTimer){ clearTimeout(inactivityTimer); inactivityTimer=null; } }
    function startInactivityCountdown(){ clearInactivity(); inactivityTimer = setTimeout(()=>{ stop(); }, 2*60*1000); }

    async function detectTorchSupport(){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        const caps = track?.getCapabilities?.();
        state.torchSupported = !!(caps && 'torch' in caps);
      }catch{ state.torchSupported = false; }
    }

    async function applyTorch(on){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        if(!track) return;
        await track.applyConstraints({ advanced:[{ torch: !!on }] });
        state.torchOn = !!on;
      }catch{ state.torchOn = false; }
    }

    async function enhanceTrack(){
      try{
        const stream = video.value?.srcObject;
        const track = stream?.getVideoTracks?.()[0];
        if(!track) return;
        try{ const ic = new ImageCapture(track); await ic.setOptions?.({ focusMode: 'continuous' }); }catch{}
        try{
          const caps = track.getCapabilities?.();
          if(caps?.zoom){
            const z=caps.zoom;
            const target=Math.min(z.max, Math.max(z.min||1,(z.min||1)*1.3));
            await track.applyConstraints({ advanced: [{ zoom: target }] });
          }
        }catch{}
      }catch{}
    }

    async function buildBackCameraConstraints(){
      const tries = [
        { video: { facingMode: { exact: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
        { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
      ];
      for(const c of tries){
        try{ const s = await navigator.mediaDevices.getUserMedia(c); s.getTracks().forEach(t=>t.stop()); return c; }catch{}
      }
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        const back = cams.find(d=>!/front|user/i.test(d.label)) || cams[0];
        if(back){ return { video: { deviceId: { exact: back.deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false }; }
      }catch{}
      return { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };
    }

    const start = async ()=>{
      if (state.running) return;
      try{
        state.running = true;
        state.locked = false;
        clearInactivity();
        try{ controls?.stop(); }catch{}

        let constraints = await buildBackCameraConstraints();
        try{
          controls = await reader.decodeFromConstraints(
            constraints,
            video.value,
            async (result, err, _controls) => {
              if (result && !state.locked) {
                state.locked = true;
                const text = result.getText();
                const format = result.getBarcodeFormat();
                state.isValid = DIGIT_DU_RE.test(text);
                state.duStatus = "";
                state.remark = "";
                clearPhoto();
                state.submitMsg = "";
                state.submitOk = false;
                state.needsStatusHint = false;
                state.needsStatusShake = false;
                state.last = { text, format };
                try{ _controls.stop(); }catch{}
                try{ reader.reset(); }catch{}
                await applyTorch(false);
                await detectTorchSupport();
                state.running = false;
                clearInactivity();
                try{ navigator.vibrate?.(30); }catch{}
              }
            }
          );
        }catch(e){
          if(e && (e.name==='OverconstrainedError' || e.name==='NotFoundError')){
            constraints = { video: true, audio:false };
            controls = await reader.decodeFromConstraints(constraints, video.value, ()=>{});
          }else{ throw e; }
        }

        await enhanceTrack();
        await detectTorchSupport();
        startInactivityCountdown();
      }catch(e){
        console.error(e);
        alert('Camera error: ' + (e?.name || '') + (e?.message ? (' - ' + e.message) : ''));
        state.running = false;
      }
    };

    const hardStopStream = ()=>{
      const s = video.value?.srcObject;
      if (s && s.getTracks) s.getTracks().forEach(t=>{ try{ t.stop(); }catch{} });
      if (video.value) video.value.srcObject = null;
      state.torchOn = false;
      state.torchSupported = false;
    };

    const stop = async ()=>{
      try{ controls?.stop(); }catch{}
      try{ reader.reset(); }catch{}
      try{ await applyTorch(false); }catch{}
      hardStopStream();
      state.running=false; state.locked=false;
      clearInactivity();
    };

    const resume = async ()=>{
      state.last=null; state.locked=false; state.isValid=false;
      state.duStatus=""; state.remark="";
      clearPhoto();
      state.submitMsg=""; state.submitOk=false;
      state.needsStatusHint=false; state.needsStatusShake=false;
      await start();
    };

    const onPickPhoto = (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      state.photoFile = file;
      try{ state.photoPreview = URL.createObjectURL(file); }catch{ state.photoPreview = ''; }
    };

    const clearPhoto = ()=>{
      try{ state.photoPreview && URL.revokeObjectURL(state.photoPreview); }catch{}
      state.photoPreview = '';
      state.photoFile = null;
    };

    // â€”â€” ä½¿ç”¨ XHR è·å–ä¸Šä¼ è¿›åº¦ + æœ¬åœ°åŒ–æ¶ˆæ¯ â€”â€” //
    const submitUpdate = async ()=>{
      if(!state.isValid){
        state.submitOk=false; state.submitMsg=t('invalidId'); return;
      }
      if(!state.duStatus){
        state.submitOk=false;
        state.submitMsg = t('needSelectStatus');
        state.needsStatusHint = true;
        state.needsStatusShake = true;
        // èšç„¦ä¸‹æ‹‰
        requestAnimationFrame(()=>{
          const sel = document.getElementById('duStatus');
          if(sel){ sel.focus(); }
          setTimeout(()=>{ state.needsStatusShake=false; }, 400);
        });
        return;
      }

      state.submitting = true;
      state.submitMsg = '';
      state.submitOk = false;
      state.uploadPct = 0;

      try{
        const isPlaceholder = !API_URL || /<ä½ çš„-render-åŸŸå>/.test(API_URL);
        if(isPlaceholder){
          throw new Error(t('apiUrlMissing'));
        }

        const fd = new FormData();
        fd.append('duId', state.last.text);
        fd.append('status', state.duStatus);         // ä¾æ—§ä¼ ä¸­æ–‡å€¼ä»¥å…¼å®¹åç«¯
        fd.append('remark', state.remark || '');
        if(state.photoFile) fd.append('photo', state.photoFile);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', API_URL, true);

        // ä¸Šä¼ è¿›åº¦
        xhr.upload.onprogress = (e)=>{
          if(e && e.lengthComputable){
            state.uploadPct = Math.min(100, Math.round(e.loaded / e.total * 100));
          }
        };

        xhr.onerror = ()=>{ state.submitOk = false; state.submitMsg = t('submitNetworkErr'); state.submitting = false; };
        xhr.onabort = ()=>{ state.submitOk = false; state.submitMsg = t('submitCanceled'); state.submitting = false; };

        xhr.onreadystatechange = ()=>{
          if(xhr.readyState !== 4) return;
          const status = xhr.status;
          const text = xhr.responseText || '';
          let data = null; try{ data = text ? JSON.parse(text) : null }catch{}

          if(status >= 200 && status < 300){
            // è‹¥åç«¯æœªè¿”å› ok/successï¼Œåˆ™è§†ä¸ºæˆåŠŸï¼ˆä¸åŸé€»è¾‘ä¸€è‡´ï¼‰
            const ok = (data && (data.ok===true || data.success===true)) || true;
            state.submitOk = !!ok;
            state.submitMsg = ok ? (data?.message || t('submitSuccess')) : (data?.message || (t('submitHttpErrPrefix') + 'unknown'));
            state.uploadPct = 100;
            if(ok){ setTimeout(()=>{ resume(); }, 600); }
          }else{
            const msg = (data && (data.detail || data.message)) || ('HTTP ' + status);
            state.submitOk = false;
            state.submitMsg = t('submitHttpErrPrefix') + msg;
          }
          state.submitting = false;
        };

        xhr.send(fd);
      }catch(err){
        console.error(err);
        state.submitOk = false;
        state.submitMsg = t('submitHttpErrPrefix') + (err?.message || err);
        state.submitting = false;
      }
    };

    onMounted(async ()=>{
      // é»˜è®¤è¯­è¨€ï¼šå°å°¼è¯­
      setLang('id');

      video.value?.setAttribute('playsinline','true');
      video.value?.setAttribute('muted','muted');
      document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stop(); });
      window.addEventListener('pagehide', stop);
      await start(); // æ‰“å¼€é¡µé¢è‡ªåŠ¨å¼€å¯æ‘„åƒå¤´
    });

    onBeforeUnmount(()=>{ stop(); });

    return {
      state, video,
      t, setLang,
      start, stop, resume,
      toggleTorch: async ()=>{ if(state.torchSupported) await applyTorch(!state.torchOn); },
      submitUpdate, onPickPhoto, clearPhoto
    };
  }
}).mount('#app');
</script>
</body>
</html>
