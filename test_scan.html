<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è€æ‰‹æœºä¼˜åŒ–ç‰ˆæ¡å½¢ç æ‰«æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body { font-family: sans-serif; margin: 0; text-align: center; background: #111; color: #fff; }
    #video { width: 100%; height: auto; background: #000; }
    #result { margin: 15px 0; font-size: 20px; color: #0f0; word-break: break-all; }
  </style>
</head>
<body>
  <h2>ğŸ“± è€æ‰‹æœºä¼˜åŒ–æ¡ç æ‰«æ</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result">è¯†åˆ«ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>

  <!-- ZXing-JS -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let resultDiv = document.getElementById('result');
    let lastResults = [];
    let stream;

    async function startScanner() {
      // åœæ‰å·²æœ‰æ‘„åƒå¤´
      if (stream) stream.getTracks().forEach(t => t.stop());

      // è‡ªåŠ¨å¯¹ç„¦+åˆ†è¾¨ç‡çº¦æŸ
      let constraints = {
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 15, max: 15 },
          focusMode: "continuous",
          advanced: [{ focusMode: "continuous" }]
        }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        console.warn("è®¾å¤‡ä¸æ”¯æŒ focusModeï¼Œå›é€€é»˜è®¤æ‘„åƒå¤´", e);
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      }
      video.srcObject = stream;

      startZXing();
    }

    // ZXing åˆå§‹åŒ–
    function startZXing() {
      const codeReader = new ZXing.BrowserMultiFormatReader();
      const hints = new Map();
      const formats = [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.CODE_39
      ];
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);

      function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // å›¾åƒé¢„å¤„ç†ï¼šç°åº¦åŒ– + å¯¹æ¯”åº¦å¢å¼º
          let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          let data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            let gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            gray = gray > 128 ? 255 : 0; // ç®€å•äºŒå€¼åŒ–
            data[i] = data[i+1] = data[i+2] = gray;
          }
          ctx.putImageData(imageData, 0, 0);

          // è§£ç 
          codeReader.decodeFromCanvas(canvas, hints)
            .then(result => handleResult(result.text))
            .catch(err => {}); // æ²¡è¯†åˆ«åˆ°å°±è·³è¿‡
        }
        setTimeout(tick, 66); // ~15fps
      }
      tick();
    }

    // å¤šå¸§ç¡®è®¤é€»è¾‘
    function handleResult(text) {
      lastResults.push(text);
      if (lastResults.length > 5) lastResults.shift();

      // å¦‚æœæœ€è¿‘ 3 å¸§ç»“æœä¸€è‡´ â†’ è¾“å‡º
      if (lastResults.slice(-3).every(r => r === text)) {
        resultDiv.innerText = "è¯†åˆ«ç»“æœ: " + text;
      }
    }

    // å¯åŠ¨
    startScanner();
  </script>
</body>
</html>
