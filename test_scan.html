<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ¡å½¢ç æ‰«æï¼ˆåç½®ä¼˜å…ˆ/é«˜æ¸…/å¯¹ç„¦/å˜ç„¦/æ‰‹ç”µï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#111; color:#fff; text-align:center; }
    h2 { margin:12px 0 6px; }
    #controls { display:flex; gap:8px; padding:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
    select, button { font-size:16px; padding:8px 10px; }
    #video { width:100%; height:auto; background:#000; }
    #result { margin: 12px 0 18px; font-size:18px; color:#0f0; word-break:break-all; min-height:1.5em; }
    #meta { font-size:12px; opacity:.8; padding:0 12px 12px; word-break:break-all; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h2>ğŸ“± æ¡å½¢ç æ‰«æï¼ˆåç½®ä¼˜å…ˆï¼‰</h2>

  <div id="controls">
    <select id="cameraSelect" title="é€‰æ‹©æ‘„åƒå¤´"></select>
    <div class="row">
      <button id="btnStart">å¼€å§‹æ‰«æ</button>
      <button id="btnTorch">æ‰‹ç”µ: å…³</button>
      <button id="btnZoomIn">æ”¾å¤§</button>
      <button id="btnZoomOut">ç¼©å°</button>
    </div>
  </div>

  <video id="video" autoplay playsinline></video>
  <div id="result">è¯†åˆ«ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
  <div id="meta"></div>

  <!-- ZXing-JS -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const videoEl = document.getElementById('video');
    const resultEl = document.getElementById('result');
    const metaEl   = document.getElementById('meta');
    const selectEl = document.getElementById('cameraSelect');
    const btnStart = document.getElementById('btnStart');
    const btnTorch = document.getElementById('btnTorch');
    const btnZoomIn= document.getElementById('btnZoomIn');
    const btnZoomOut= document.getElementById('btnZoomOut');

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let last = [];
    let torchOn = false;
    let zoomLevel = null;

    // â€”â€” å·¥å…·ï¼šåˆ¤æ–­/è¯„åˆ†æ‘„åƒå¤´æ ‡ç­¾ â€”â€” //
    const isFront = (label='') => /front|user/i.test(label);
    const scoreLabel = (label='') => {
      let s = 0;
      if (/back|rear|environment/i.test(label)) s += 10;
      if (/main|wide|default/i.test(label))     s += 5;
      if (/tele|macro|ultra/i.test(label))      s += 1;
      if (isFront(label))                        s -= 100;
      return s;
    };

    // å…ˆå°è¯•ä¸€æ¬¡æƒé™ï¼Œè¿™æ · enumerateDevices æ‰æœ‰åç§°
    async function preWarmPermission() {
      try {
        const s = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            // å°½åŠ›è¿ç»­è‡ªåŠ¨å¯¹ç„¦ï¼ˆå¹¶éæ‰€æœ‰æµè§ˆå™¨æ”¯æŒï¼‰
            advanced: [{ focusMode: "continuous" }]
          }
        });
        s.getTracks().forEach(t => t.stop());
      } catch (e) {
        console.warn("é¢„è·å–æƒé™å¤±è´¥ï¼ˆç¨åå¼€å§‹æ—¶å†ç”³è¯·ï¼‰ï¼š", e);
      }
    }

    async function populateCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      let videos = devices.filter(d => d.kind === 'videoinput');

      // å±è”½å‰ç½®ï¼›è‹¥å…¨è¢«å±è”½åˆ™å›é€€åˆ°å…¨åˆ—è¡¨
      let filtered = videos.filter(d => !isFront(d.label));
      if (filtered.length === 0) filtered = videos;

      // æŒ‰â€œåƒåç½®ä¸»æ‘„â€çš„ç¨‹åº¦æ’åº
      filtered.sort((a, b) => scoreLabel(b.label) - scoreLabel(a.label));

      // æ¸²æŸ“ä¸‹æ‹‰æ¡†å¹¶é»˜è®¤é€‰ä¸­ç¬¬ä¸€é¡¹
      selectEl.innerHTML = '';
      filtered.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.text  = d.label || `æ‘„åƒå¤´ ${i+1}`;
        selectEl.appendChild(opt);
      });
    }

    // è®¾ç½®ä»…è¯†åˆ« EAN-13 / Code39
    function setHints() {
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.CODE_39
      ]);
      codeReader.hints = hints;
    }

    // å¯åŠ¨å¹¶å°½é‡å¼€å¯å¯¹ç„¦/å˜ç„¦/æ‰‹ç”µ
    async function start() {
      resultEl.textContent = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
      metaEl.textContent = "";
      last = [];
      torchOn = false;
      btnTorch.textContent = "æ‰‹ç”µ: å…³";

      codeReader.reset();
      setHints();

      const deviceId = selectEl.value || undefined;

      // decodeFromVideoDevice å†…éƒ¨ä¼š getUserMediaï¼›æˆ‘ä»¬ç”¨ ideal æ–¹å¼è¯·æ±‚æ›´é«˜åˆ†è¾¨ç‡
      // ä¸€äº›ç‰ˆæœ¬ä¸æ”¯æŒç›´æ¥ä¼  constraintsï¼Œè¿™é‡Œä¾èµ–æµè§ˆå™¨çš„é»˜è®¤åå•†ç»“æœã€‚
      try {
        await codeReader.decodeFromVideoDevice(deviceId, videoEl, (result, err) => {
          if (result && result.text) handleResult(result.text);
        });

        resultEl.textContent = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œæ­£åœ¨è¯†åˆ«â€¦";

        // ç­‰å¾… video å¸§å…ƒæ•°æ®å°±ç»ªåï¼Œå°è¯•æ§åˆ¶ torch / zoomï¼Œå¹¶æ‰“å°å®é™…åˆ†è¾¨ç‡
        videoEl.addEventListener('loadedmetadata', applyTrackControls, { once: true });
      } catch (e) {
        console.error(e);
        resultEl.textContent = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼š" + e;
      }
    }

    async function applyTrackControls() {
      const stream = videoEl.srcObject;
      if (!stream) return;
      const track = stream.getVideoTracks()[0];
      if (!track) return;

      // æ‰“å°å®é™…åˆ†è¾¨ç‡/è®¾å¤‡èƒ½åŠ›
      const settings = track.getSettings?.() || {};
      const caps = track.getCapabilities?.() || {};
      metaEl.textContent = `å®é™…åˆ†è¾¨ç‡: ${videoEl.videoWidth} x ${videoEl.videoHeight}
settings: ${JSON.stringify(settings)}
capabilities: ${JSON.stringify(Object.keys(caps))}`;

      // ä¿å­˜åˆå§‹ zoom
      if (caps.zoom) {
        const mid = Math.min(caps.zoom.max, Math.max(caps.zoom.min, (caps.zoom.min + caps.zoom.max)/2));
        zoomLevel = mid;
        try { await track.applyConstraints({ advanced: [{ zoom: zoomLevel }] }); } catch {}
      }

      // é»˜è®¤ä¸å¼€æ‰‹ç”µï¼ŒæŒ‰é’®å¯åˆ‡æ¢
      // å¯¹ç„¦ï¼ˆcontinuousï¼‰å¤§å¤šåœ¨ getUserMedia é˜¶æ®µç”±æµè§ˆå™¨è‡ªè¡Œå¤„ç†ï¼Œéƒ¨åˆ†æµè§ˆå™¨å¯å†æ¬¡å°è¯•ï¼š
      try { await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] }); } catch {}
    }

    // å¤šå¸§æŠ•ç¥¨ï¼ˆæœ€è¿‘ 5 å¸§ï¼Œå‡ºç° â‰¥2 æ¬¡å³ç¡®è®¤ï¼‰
    function handleResult(text) {
      last.push(text);
      if (last.length > 5) last.shift();
      const counts = {};
      last.forEach(x => counts[x] = (counts[x] || 0) + 1);
      const [best, n] = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
      if (n >= 2) resultEl.textContent = "è¯†åˆ«ç»“æœï¼š" + best;
    }

    // â€”â€” æ‰‹ç”µ/å˜ç„¦æ§åˆ¶ â€”â€” //
    btnTorch.addEventListener('click', async () => {
      const track = videoEl.srcObject?.getVideoTracks?.()[0];
      const caps = track?.getCapabilities?.();
      if (!track || !caps?.torch) { alert('æ­¤è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒæ‰‹ç”µæ§åˆ¶'); return; }
      torchOn = !torchOn;
      try {
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        btnTorch.textContent = `æ‰‹ç”µ: ${torchOn ? 'å¼€' : 'å…³'}`;
      } catch (e) { console.warn(e); }
    });

    async function adjustZoom(step) {
      const track = videoEl.srcObject?.getVideoTracks?.()[0];
      const caps = track?.getCapabilities?.();
      if (!track || !caps?.zoom) { alert('æ­¤è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒå˜ç„¦'); return; }
      if (zoomLevel == null) zoomLevel = caps.zoom.min || 1;
      zoomLevel = Math.min(caps.zoom.max, Math.max(caps.zoom.min, zoomLevel + step));
      try { await track.applyConstraints({ advanced: [{ zoom: zoomLevel }] }); } catch (e) { console.warn(e); }
    }
    btnZoomIn.addEventListener('click', () => adjustZoom(+0.2));
    btnZoomOut.addEventListener('click', () => adjustZoom(-0.2));

    // é€‰æ‹©å˜åŒ–å³åˆ‡æ¢æ‘„åƒå¤´
    selectEl.addEventListener('change', start);
    btnStart.addEventListener('click', start);

    // åˆå§‹åŒ–ï¼šå°è¯•æƒé™ -> åˆ—è®¾å¤‡
    (async () => {
      await preWarmPermission();
      await populateCameras();
    })();
  </script>
</body>
</html>
