<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æ¡å½¢ç æ‰«æï¼ˆåªæ˜¾ç¤ºåç½®/å¤–æ¥æ‘„åƒå¤´ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#111; color:#fff; text-align:center; }
    #controls { display:flex; gap:8px; padding:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
    select, button { font-size:16px; padding:8px 10px; }
    #video { width:100%; height:auto; background:#000; }
    #result { margin: 12px 0 18px; font-size:18px; color:#0f0; word-break:break-all; }
  </style>
</head>
<body>
  <h2 style="margin:12px 0 0;">ğŸ“± æ¡å½¢ç æ‰«æï¼ˆåç½®ä¼˜å…ˆï¼‰</h2>
  <div id="controls">
    <select id="cameraSelect" title="é€‰æ‹©æ‘„åƒå¤´"></select>
    <button id="btnStart">å¼€å§‹æ‰«æ</button>
  </div>
  <video id="video" autoplay playsinline></video>
  <div id="result">è¯†åˆ«ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>

  <!-- ZXing-JS -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const videoEl = document.getElementById('video');
    const resultEl = document.getElementById('result');
    const selectEl = document.getElementById('cameraSelect');
    const btnStart = document.getElementById('btnStart');

    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentDeviceId = undefined;

    // è¿‡æ»¤æ‰å‰ç½®ï¼šlabel å« front / user çš„è®¤ä¸ºæ˜¯å‰ç½®
    function isFrontFacingLabel(label='') {
      return /front|user/i.test(label);
    }
    // æ’åºï¼šæ›´åƒä¸»æ‘„/åç½®çš„æ’å‰
    function scoreLabel(label='') {
      let score = 0;
      if (/back|rear|environment/i.test(label)) score += 10;
      if (/wide|main|default/i.test(label))     score += 5;
      if (/tele|macro|ultra/i.test(label))      score += 1; // æ¬¡ä¼˜å…ˆ
      if (isFrontFacingLabel(label))            score -= 100;
      return score;
    }

    // å…ˆç”³è¯·ä¸€æ¬¡æƒé™ä»¥æ‹¿åˆ°è®¾å¤‡åç§°
    async function ensurePermission() {
      try {
        const s = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            // å°è¯•å¯ç”¨è¿ç»­å¯¹ç„¦ï¼ˆéƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰
            focusMode: "continuous",
            advanced: [{ focusMode: "continuous" }]
          }
        });
        s.getTracks().forEach(t => t.stop());
      } catch (e) {
        console.warn("æœªèƒ½é¢„è·å–æƒé™ï¼ˆç¨åå¼€å§‹æ‰«ææ—¶å†ç”³è¯·ï¼‰ï¼š", e);
      }
    }

    async function populateCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      let videos = devices.filter(d => d.kind === 'videoinput');

      // å…ˆå‰”é™¤æ˜æ˜¾çš„å‰ç½®
      let backOrExternal = videos.filter(d => !isFrontFacingLabel(d.label));

      // å¦‚æœå…¨è¢«å‰”é™¤äº†ï¼ˆæœ‰äº›æµè§ˆå™¨ä¸ç»™æ¸…æ™°æ ‡ç­¾ï¼‰ï¼Œå°±é€€å›åˆ°å…¨åˆ—è¡¨
      if (backOrExternal.length === 0) backOrExternal = videos;

      // æŒ‰â€œåƒåç½®ä¸»æ‘„â€çš„ç¨‹åº¦æ’åº
      backOrExternal.sort((a, b) => scoreLabel(b.label) - scoreLabel(a.label));

      // æ¸²æŸ“ä¸‹æ‹‰æ¡†
      selectEl.innerHTML = '';
      backOrExternal.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.text  = d.label || `æ‘„åƒå¤´ ${i + 1}`;
        selectEl.appendChild(opt);
      });

      // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯åç½®ä¸»æ‘„ï¼‰
      if (backOrExternal[0]) {
        selectEl.value = backOrExternal[0].deviceId;
        currentDeviceId = backOrExternal[0].deviceId;
      }
    }

    function setHints() {
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.CODE_39
      ]);
      // ç›´æ¥æŠŠ hints èµ‹ç»™å®ä¾‹ï¼ˆå…¼å®¹ä¸åŒç‰ˆæœ¬çš„ zxing-jsï¼‰
      codeReader.hints = hints;
    }

    async function start() {
      resultEl.textContent = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
      // å…ˆé‡ç½®ï¼Œé¿å…å¤šæ¬¡å¯åŠ¨å åŠ 
      codeReader.reset();
      setHints();

      const deviceId = selectEl.value || currentDeviceId || undefined;

      try {
        await codeReader.decodeFromVideoDevice(
          deviceId,
          videoEl,
          (result, err) => {
            if (result && result.text) {
              handleResult(result.text);
            }
          }
        );
        resultEl.textContent = "æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œæ­£åœ¨è¯†åˆ«â€¦";
      } catch (e) {
        console.error(e);
        resultEl.textContent = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼š" + e;
      }
    }

    // ç®€å•çš„å¤šå¸§æŠ•ç¥¨ï¼ˆæœ€è¿‘ 5 å¸§ï¼Œå‡ºç° â‰¥2 æ¬¡å°±ç¡®è®¤ï¼‰
    const last = [];
    function handleResult(text) {
      last.push(text);
      if (last.length > 5) last.shift();
      const counts = {};
      last.forEach(x => counts[x] = (counts[x] || 0) + 1);
      const [best, n] = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
      if (n >= 2) resultEl.textContent = "è¯†åˆ«ç»“æœï¼š" + best;
    }

    // é€‰æ‹©å˜åŒ–æ—¶ï¼Œç«‹å³åˆ‡æ¢æ‘„åƒå¤´
    selectEl.addEventListener('change', () => {
      currentDeviceId = selectEl.value;
      start();
    });
    btnStart.addEventListener('click', start);

    // åˆå§‹åŒ–
    (async () => {
      await ensurePermission();
      await populateCameras();
    })();
  </script>
</body>
</html>
